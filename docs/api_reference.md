# 자막 인덱서 API 및 라우터 문서

## API 개요

현재 애플리케이션은 FastAPI 기반으로 다음과 같은 주요 모듈로 구성되어 있습니다:

```
app/
├── routes/               # 라우터 모듈
│   ├── search.py         # 검색 관련 라우터
│   ├── indexing.py       # 인덱싱 관련 라우터 
│   ├── stats.py          # 통계 관련 라우터
│   ├── subtitle_handler.py  # 자막 처리 라우터
│   ├── database_manager.py  # DB 관리 라우터
│   └── docs.py           # 문서화 라우터
├── services/             # 비즈니스 로직
│   ├── indexer.py        # 인덱싱 서비스
│   ├── search.py         # 검색 서비스
│   └── stats.py          # 통계 서비스
├── database/             # 데이터베이스 액세스 계층
│   ├── __init__.py       # 패키지 초기화 및 Database 클래스
│   ├── connection.py     # 데이터베이스 연결 관리
│   ├── schema.py         # 스키마 정의 및 관리
│   ├── media.py          # 미디어 파일 관련 CRUD
│   └── subtitles.py      # 자막 관련 CRUD
├── models/               # 데이터 모델
│   ├── media.py          # 미디어 모델
│   └── subtitle.py       # 자막 모델
└── subtitle/             # 자막 처리 모듈
    ├── encodings/        # 인코딩 관련
    ├── extractors/       # 자막 추출 관련
    └── utils/            # 유틸리티
```

## 주요 라우터 및 엔드포인트

### 1. 검색 API (`/api/search`)

| 엔드포인트 | 메서드 | 설명 | 실시간 데이터 |
|------------|--------|------|--------------|
| `/api/search` | GET | 자막 내용 검색 | ✅ DB 검색 |
| `/api/search/stats` | GET | 검색 통계 조회 | ✅ DB 통계 |

### 2. 인덱싱 API (`/api`)

| 엔드포인트 | 메서드 | 설명 | 실시간 데이터 |
|------------|--------|------|--------------|
| `/api/indexing/status` | GET | 인덱싱 상태 조회 | ✅ 실시간 상태 |
| `/api/indexing/progress` | GET | 인덱싱 진행률 조회 | ✅ 실시간 진행률 |
| `/api/indexing/logs` | GET | 인덱싱 로그 조회 | ✅ 실시간 로그 |
| `/api/indexing/start` | POST | 인덱싱 작업 시작 | ✅ 백그라운드 작업 |
| `/api/indexing/stop` | POST | 인덱싱 작업 중지 | ✅ 백그라운드 작업 |
| `/api/indexing/pause` | POST | 인덱싱 일시정지 | ✅ 백그라운드 작업 |
| `/api/indexing/resume` | POST | 인덱싱 재개 | ✅ 백그라운드 작업 |

### 3. 자막 처리 API (`/subtitle`)

| 엔드포인트 | 메서드 | 설명 | 실시간 데이터 |
|------------|--------|------|--------------|
| `/subtitle` | GET | 자막 관리 페이지 | ❌ 정적 페이지 |
| `/subtitle/scan` | GET | 자막 검색 결과 | ✅ 파일시스템 검색 |
| `/subtitle/upload` | POST | 자막 파일 업로드 | ✅ 파일시스템 저장 |
| `/subtitle/convert` | POST | 자막 인코딩 변환 | ✅ 파일 처리 |
| `/subtitle/extract` | GET | 자막 추출 | ✅ 미디어 파일 처리 |

### 4. 데이터베이스 관리 API (`/api/db`)

| 엔드포인트 | 메서드 | 설명 | 실시간 데이터 |
|------------|--------|------|--------------|
| `/api/db/info` | GET | DB 정보 조회 | ✅ DB 메타데이터 |
| `/api/db/tables` | GET | 테이블 목록 조회 | ✅ DB 스키마 |
| `/api/db/table/{table_name}` | GET | 테이블 데이터 조회 | ✅ DB 데이터 |
| `/api/db/stats` | GET | DB 통계 조회 | ✅ DB 통계 |

### 5. 통계 API (`/api/stats`)

| 엔드포인트 | 메서드 | 설명 | 실시간 데이터 |
|------------|--------|------|--------------|
| `/api/stats/general` | GET | 일반 통계 조회 | ✅ DB 통계 |
| `/api/stats/subtitles` | GET | 자막 통계 조회 | ✅ DB 통계 |
| `/api/stats/media` | GET | 미디어 통계 조회 | ✅ DB 통계 |

### 6. 문서 API (`/docs`)

| 엔드포인트 | 메서드 | 설명 | 실시간 데이터 |
|------------|--------|------|--------------|
| `/docs` | GET | 문서 목록 페이지 | ❌ 정적 페이지 |
| `/docs/{doc_path}` | GET | 특정 문서 페이지 | ❌ 정적 페이지 |

## UI 페이지

| 페이지 | 경로 | 설명 | 실시간 데이터 |
|-------|------|------|--------------|
| 대시보드 | `/dashboard` | 시스템 대시보드 | ✅ 통계, 상태 |
| 검색 | `/search` | 자막 검색 인터페이스 | ✅ 검색 결과 |
| 인덱싱 관리 | `/indexing_process` | 인덱싱 모니터링 | ✅ 진행 상태, 로그 |
| 환경 설정 | `/config` | 시스템 설정 | ✅ 설정 저장/로드 |
| DB 관리 | `/database_manager` | 데이터베이스 관리 | ✅ DB 데이터 |

## 주요 서비스 모듈

### 1. 인덱싱 서비스 (`app/services/indexer.py`)

인덱서 서비스 클래스(`IndexerService`)를 통해 미디어 파일과 자막을 인덱싱합니다:

- **주요 기능**:
  - 미디어 파일 스캔 및 처리
  - 자막 파일 인식 및 처리
  - 여러 인덱싱 전략 지원 (표준, 배치, 병렬, 지연 언어 감지)
  - 인덱싱 상태 관리 (시작/중지/일시중지/재개)
  - 로그 기록 및 상태 추적
  - 예상 완료 시간 계산

- **주요 메서드**:
  - `start_indexing(incremental=True)`: 인덱싱 작업 시작
  - `stop_indexing()`: 인덱싱 작업 중지
  - `pause_indexing()`: 인덱싱 일시중지
  - `resume_indexing()`: 인덱싱 재개
  - `get_status()`: 현재 인덱싱 상태 반환
  - `scan_directory()`: 디렉토리 스캔 및 미디어 파일 추출
  - `process_subtitle()`: 자막 파일 처리 및 DB 저장

### 2. 데이터베이스 액세스 계층 (`app/database`)

데이터베이스 작업을 처리하는 모듈화된 패키지:

- **주요 모듈**:
  - `connection.py`: 데이터베이스 연결 관리
  - `schema.py`: 테이블 및 인덱스 정의/생성
  - `media.py`: 미디어 파일 관련 CRUD 작업
  - `subtitles.py`: 자막 관련 CRUD 작업

- **주요 기능**:
  - 데이터베이스 초기화 및 테이블 생성
  - 미디어 및 자막 정보 저장/조회/업데이트
  - FTS(Full-Text Search) 인덱스 관리
  - 증분 업데이트 지원
  - 통계 정보 생성

### 3. 자막 처리 모듈 (`app/subtitle`)

자막 파일 처리와 관련된 모듈화된 패키지:

- **주요 모듈**:
  - `encodings/`: 인코딩 감지 및 변환
  - `extractors/`: 다양한 자막 형식 추출기
  - `utils/`: 자막 처리 유틸리티

- **주요 기능**:
  - 자막 파일 인코딩 자동 감지
  - 다양한 형식의 자막 파싱 (.srt, .ass, .smi 등)
  - 자막 텍스트 정규화 및 언어 감지
  - 미디어 파일에서 내장 자막 추출

## 실시간 데이터 연동 방식

현재 시스템은 다음 방식으로 실시간 데이터를 처리합니다:

1. **HTMX를 통한 부분 업데이트**
   - 주기적 폴링: 인덱싱 상태, 진행률은 5초마다 자동 갱신
   - 이벤트 기반 갱신: 작업 시작/중지/일시정지/재개 시 UI 갱신

2. **WebSocket 도입 가능성**
   - 현재: 폴링 방식 사용 중
   - 개선 가능점: 인덱싱 상태, 로그 실시간 업데이트를 위한 WebSocket 도입

3. **백그라운드 작업**
   - 인덱싱: 별도 스레드로 실행되어 FastAPI 서버 차단 없이 작동
   - 상태 모니터링: 공유 상태 객체 및 파일 기반 상태 저장을 통해 진행상황 추적

4. **데이터베이스 연동**
   - SQLite: 모든 검색, 통계, 데이터 조회는 실시간으로 DB 접근
   - FTS(전문 검색): 자막 내용 전체 텍스트 검색 지원

## 개선 가능한 부분

1. **WebSocket 통합**
   - 인덱싱 상태 실시간 업데이트
   - 로그 스트리밍

2. **비동기 작업 관리**
   - 큐 시스템 도입 (Celery/Redis)
   - 작업 우선순위, 재시도 메커니즘

3. **API 버전 관리**
   - 명시적 API 버전 관리 `/api/v1/...`

4. **API 문서화 강화**
   - OpenAPI 사양 확장
   - 더 상세한 예제와 응답 모델 문서화

이 문서는 애플리케이션의 현재 상태를 반영하며, 코드 변경 시 함께 업데이트해야 합니다. 
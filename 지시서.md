💡 목적: 사용자가 웹 UI에서 버튼을 클릭하면,  
서버는 지정된 디렉토리를 재귀적으로 탐색하고,  
영어 `.srt` 자막을 가진 영상들을 DB에 인덱싱하라.

✅ 전체 구조

- 백엔드: FastAPI
- 프론트: HTML + htmx ( javascript 없이 동작.)
- DB: SQLite

<!-- Claude3.7 의견: FastAPI의 WebSocket을 활용하면 인덱싱 진행 상황을 실시간으로 클라이언트에 전송할 수 있어, 긴 작업의 진행 상태를 더 효율적으로 표시할 수 있습니다. -->

✅ 기능 요구사항:

📡 AI 친화형 구조 설계

AI가 웹페이지를 정확히 분석하고, 메뉴 및 기능 구조를 이해하도록 하기 위해 다음 구조를 명시적으로 도입한다:

1. HTML 태그 구조
   - 메뉴는 `<nav>`, 본문은 `<main>`, 섹션은 `<section>` 등 semantic 태그로 구분
   - 주요 컴포넌트에 ID 및 클래스명을 명확하게 명시 (`id="subtitle-search"`, `class="media-list"`)
   - 버튼, 폼 등의 요소에는 `aria-label` 및 `role`을 활용하여 기능 전달

2. 구조 메타데이터 제공
   - `/ui-structure.json` 또는 `/meta/structure.json`과 같은 엔드포인트에서 메뉴/기능 구조 제공
   - 예시 JSON 구조:
     ```json
     {
       "pages": [
         { "url": "/index", "title": "인덱싱", "purpose": "미디어 파일 인덱싱" },
         { "url": "/search", "title": "검색", "purpose": "자막 검색 기능" }
       ],
       "nav": ["홈", "인덱싱", "검색", "설정"]
     }
     ```

3. UI 구성 유지 전략
   - Tailwind 등의 유틸리티 CSS는 사용하되, 클래스가 과도하게 꼬이지 않도록 atomic 구조 유지
   - htmx는 가능한 명확한 endpoint에 연결하고, `hx-target`, `hx-swap` 속성으로 부분 갱신 위치를 명시함
   - 페이지 주요 블록은 `<!-- #섹션명 시작 --> ... <!-- #섹션명 끝 -->` 형식의 주석으로 구획 구분

이 구조는 AI 기반 자동 분석 도구나 클론 제작 시스템이 메뉴, 기능, UI 구성을 빠르게 이해하고 자동화된 리팩토링 및 유지보수 제안을 할 수 있도록 돕는다.

#### 💡 개발 시 자동화 전략

AI 코드 에디터(Copilot, Cursor 등)가 개발 중 자동으로 `ui-structure.json`을 작성하거나 업데이트할 수 있도록 다음 전략을 권장한다:

1. 라우트 등록 시 구조 정의 자동 생성
   - FastAPI 라우트 등록 시, `@track_ui_route` 데코레이터 사용
   - 해당 URL, 템플릿 이름, 목적을 기반으로 자동 JSON 구조에 추가

2. 개발 중 실시간 구조 변경 감지
   - AI 에디터가 `.py`, `.html` 수정 시 구조 변화를 감지하여 반영 제안
   - 예: 메뉴 항목이 추가되면 `nav` 필드 자동 갱신

3. 구조 JSON 위치
   - 표준화된 위치: `/static/meta/ui-structure.json`
   - export 대상 도구(Figma, Bolt, Octopus 등)에서도 쉽게 접근 가능

4. 수동 편집 지원
   - `.json` 파일을 직접 열어도 수정이 쉽도록 사람이 읽기 쉬운 구조로 유지
   - 구조 필드에 주석 삽입 (`// 인덱싱 페이지`, `// 검색 기능 등`)

이 전략을 적용하면, 개발 중 구조 문서가 자연스럽게 함께 생성되므로 AI 기반 클론, 리팩토링, 유지보수, 자동 테스트 구성에도 큰 이점을 제공한다.

1. [서버 기능]

- 인덱싱 버튼 (`/index`)을 누르면 FastAPI가 `root_dir` 하위 전체를 스캔한다.
  <!-- Gemini 2.5pro 의견: `root_dir`은 설정(config.json)에서 관리하는 것이 좋습니다. -->
  <!-- Claude3.7 의견: 설정 파일에 최근 스캔 시간도 기록하면, 마지막 스캔 이후 변경된 파일만 선택적으로 스캔하는 증분 인덱싱 기능을 구현할 수 있습니다. -->
- 대상 미디어 확장자: `.mp4`, `.mkv`, `.avi`, `.mp3`, `.wav`
  <!-- Gemini 2.5pro 의견: 확장자는 대소문자를 구분하지 않도록 처리해야 합니다. -->
  <!-- Claude3.7 의견: 확장자 목록을 설정에서 사용자가 추가/제거할 수 있게 하면 유연성이 높아집니다. -->
- 같은 경로에 `.srt` 자막이 있으면 다음을 수행:
  - 태그 (`<i>`, `<b>`, `<font>`) 제거
    <!-- Gemini 2.5pro 의견: 정규식으로 처리 가능하지만, `pysrt` 같은 라이브러리를 사용하면 더 안정적으로 다양한 태그와 형식을 처리할 수 있습니다. -->
    <!-- Claude3.7 해결방안: `pysrt`와 같은 라이브러리를 사용하고, 태그 처리는 BeautifulSoup을 활용하면 HTML 태그를 안전하게 제거할 수 있습니다. -->
  - 영어가 아닌 자막이면 무시
    <!-- Gemini 2.5pro 의견: '영어' 판별 기준을 명확히 해야 합니다. 예를 들어, 자막 내용의 처음 몇 줄을 샘플링하여 `langdetect` 같은 라이브러리로 언어를 감지하는 방식을 고려할 수 있습니다. 정확도와 처리 속도 간의 트레이드오프가 있습니다. 또는 설정에서 기본 언어를 'en'으로 지정하고, 다른 언어 감지 시 무시하는 방식을 사용할 수도 있습니다. -->
    <!-- Claude3.7 아이디어: 샘플링된 텍스트에서 영어 단어 비율을 계산하여 임계값(예: 70%)을 넘으면 영어로 간주하는 방식으로 처리 속도와 정확성의 균형을 맞출 수 있습니다. -->
  - 시간(`start`, `end`)과 자막(`text`) 단위로 분리
  - `subtitles` 테이블에 저장
    <!-- Gemini 2.5pro 의견: 인덱싱 작업은 시간이 오래 걸릴 수 있으므로, FastAPI의 `BackgroundTasks`를 사용하여 비동기적으로 처리하고, UI에는 진행 상태를 알리는 것이 좋습니다. (예: "파일 스캔 중...", "N개 파일 처리 완료") -->
    <!-- Gemini 2.5pro 의견: 파일/디렉토리 접근 권한 오류, 잘못된 자막 형식, DB 오류 등 예외 처리 방안을 구체화해야 합니다. -->
    <!-- Claude3.7 해결방안: 작업을 여러 단계(파일 검색, 자막 분석, DB 저장)로 나누어 각 단계별 진행 상태를 보고하고, 오류 발생 시 특정 단계에서 재시도하거나 건너뛸 수 있는 구조로 설계하면 견고성이 향상됩니다. -->

2. [프론트 기능]

- 버튼: `인덱싱 시작` → POST `/index`
- 완료되면 "총 X개의 미디어, Y개의 자막 등록됨" 결과 표시
  <!-- Gemini 2.5pro 의견: `/index` API의 응답 형식을 정의해야 합니다. (예: `{"media_count": X, "subtitle_count": Y, "status": "completed"}`) -->
  <!-- Gemini 2.5pro 의견: 인덱싱 진행 중 상태 표시 (예: 스피너, 진행률)를 htmx 폴링 등으로 구현하는 것을 고려해볼 수 있습니다. -->
  <!-- Claude3.7 아이디어: 인덱싱 시간이 길어질 경우를 대비해 작업 ID를 반환하고, 클라이언트는 이 ID로 상태를 주기적으로 확인하는 방식을 구현할 수 있습니다. 또는 SSE(Server-Sent Events)를 활용해 실시간 업데이트를 제공할 수도 있습니다. -->
- 설정 메뉴에서 디렉토리, DB 경로, 언어를 설정할 수 있음 (기본값 설정은 json/config 사용)
  <!-- Gemini 2.5pro 의견: `config.json`에 저장될 구체적인 항목 (예: `root_dir`, `db_path`, `default_language`)을 명시하는 것이 좋습니다. DB 경로를 설정 가능하게 하면 유연성이 높아집니다. -->
  <!-- Claude3.7 의견: 설정 변경 시 변경 내용을 즉시 저장하고, 변경된 설정이 적용되는 타이밍(즉시/다음 작업 시)을 명확히 사용자에게 알려주는 것이 좋습니다. -->

✅ DB 스키마

📦 media_files

- id (PK)
- path (TEXT, 루트 기준 상대 경로)
  <!-- Gemini 2.5pro 의견: `root_dir` 자체도 설정이나 DB에 저장하여, 상대 경로의 기준점을 명확히 하는 것이 좋습니다. -->
  <!-- Claude3.7 해결방안: 테이블에 `root_dir_id` 필드를 추가하고 별도의 `root_directories` 테이블을 만들어 관리하면, 여러 소스 디렉토리를 지원하면서도 경로 변경 시 일괄 업데이트가 용이해집니다. -->
- has_subtitle (BOOLEAN)
  <!-- Claude3.7 아이디어: 파일 크기, 미디어 길이(duration), 마지막 수정 시간 등의 메타데이터를 추가로 저장하면 검색 및 필터링에 유용합니다. -->

📑 subtitles

- id (PK)
- media_id (FK to media_files.id)
- start_time (TEXT `00:01:23,000`)
- end_time (TEXT)
  <!-- Gemini 2.5pro 의견: 시간을 TEXT 대신 INTEGER (밀리초)로 저장하면 시간 기반 검색/정렬 시 더 효율적일 수 있습니다. 필요시 애플리케이션 레벨에서 포맷팅합니다. -->
  <!-- Claude3.7 의견: 시간을 정수형(밀리초)으로 저장하고 인덱스를 추가하면 '특정 시간대의 자막 검색'과 같은 쿼리의 성능이 크게 개선됩니다. -->
- content (TEXT)
- lang (TEXT, `'en'`)
  <!-- Gemini 2.5pro 의견: 언어 감지 기능을 구현한다면, 감지된 언어 코드를 저장할 수 있습니다. (예: 'ko', 'ja') -->
  <!-- Claude3.7 아이디어: 자막 내용에 대한 전문 검색(full-text search)을 위해 FTS5 가상 테이블을 추가로 구성하면 키워드 검색 성능이 크게 향상됩니다. -->

✅ 추가 조건

- 자막이 없어도 `media_files`에는 무조건 기록됨
- 태그 제거는 정규식으로 처리
  <!-- Gemini 2.5pro 의견: 위에서 언급했듯이, 라이브러리 사용을 재고려해볼 수 있습니다. -->
- `.srt` 자막은 UTF-8 및 BOM 자동 대응
  <!-- Gemini 2.5pro 의견: Python의 `open()` 함수에서 `encoding='utf-8-sig'`를 사용하면 BOM을 자동으로 처리할 수 있습니다. 다양한 인코딩 가능성(예: ANSI)도 고려해야 할 수 있습니다. `chardet` 라이브러리로 인코딩을 감지하는 방법도 있습니다. -->
  <!-- Claude3.7 해결방안: `chardet` 라이브러리로 인코딩을 자동 감지하고, 오류 발생 시 여러 인코딩을 시도해보는 폴백 메커니즘을 구현하면 다양한 환경의 자막 파일을 안정적으로 처리할 수 있습니다. -->
- HTML은 tailwind 기반, 자막과 상태는 htmx로 부분 갱신
  <!-- Claude3.7 아이디어: Tailwind의 다크 모드를 지원하여 사용자가 선호하는 테마를 선택할 수 있게 하면 UI 경험이 향상됩니다. -->

<!-- Gemini 2.5pro 추가 고려사항:
- **중복 인덱싱 방지:** 동일한 파일을 다시 인덱싱할 때 어떻게 처리할지 정의해야 합니다. (예: 기존 데이터 삭제 후 재인덱싱, 변경된 파일만 업데이트, 무시)
- **로그 기록:** 인덱싱 과정 중 발생하는 오류나 주요 이벤트(시작, 완료, 건너뛴 파일 등)를 로그 파일에 기록하면 디버깅에 유용합니다.
- **테스트:** 단위 테스트 및 통합 테스트 계획을 수립하여 기능의 정확성을 검증하는 것이 좋습니다.
-->

<!-- Claude3.7 추가 고려사항:
1. **사용자 친화적 오류 처리**: 기술적 오류 메시지보다는 사용자가 이해하고 조치할 수 있는 명확한 오류 메시지와 해결 방안을 제시합니다.
2. **자막 검색 기능**: subtitles 테이블에서 특정 단어나 구문을 검색하고 해당 미디어 파일과 시간대를 표시하는 기능을 추가하면 활용도가 높아집니다.
3. **병렬 처리**: 대량의 파일을 처리할 때 멀티프로세싱을 활용하면 인덱싱 속도를 크게 향상시킬 수 있습니다.
4. **메모리 최적화**: 대용량 파일 처리 시 메모리 사용량을 모니터링하고, 필요 시 청크 단위로 처리하는 전략을 구현합니다.
5. **주기적 백업**: DB가 손상될 경우를 대비해 주기적 백업 기능을 구현하는 것이 안전합니다.
-->

<!-- Claude3.7 제안: UI 메뉴 구성 및 레이아웃 -->

✅ 메뉴 구성 제안

1. **메인 네비게이션**

   - 홈: 앱 개요 및 최근 활동 요약
   - 인덱싱: 인덱싱 작업 시작 및 현황 확인
   - 검색: 자막 내용 검색 인터페이스
   - 통계: 인덱싱된 미디어 및 자막 통계
   - 설정: 앱 설정 관리

2. **설정 서브메뉴**
   - 디렉토리 설정: 스캔 대상 경로 지정
   - DB 설정: 데이터베이스 위치 및 옵션
   - 인덱싱 설정: 파일 확장자, 언어 감지 옵션
   - 고급 설정: 성능, 캐싱, 로그 관련 옵션

✅ 레이아웃 제안

```
+-------------------------------------------------------+
|                      헤더 / 로고                       |
+---------------+-------------------------------------+
|               |                                     |
|               |                                     |
|   사이드바     |            메인 콘텐츠 영역            |
|  (네비게이션)   |                                     |
|               |                                     |
|               |                                     |
|               |                                     |
|               |                                     |
+---------------+-------------------------------------+
|                 푸터 / 상태 표시줄                    |
+-------------------------------------------------------+
```

**주요 페이지별 레이아웃**

1. **인덱싱 페이지**

```
+-------------------------------------------------------+
|                     헤더 / 네비게이션                   |
+-------------------------------------------------------+
|  현재 설정된 루트 디렉토리: /path/to/media              |
+-------------------------------------------------------+
|  [ 인덱싱 시작 ]    [ 인덱싱 중지 ]    [ 설정 변경 ]    |
+-------------------------------------------------------+
|                                                       |
|  진행 상태:  [=========>           ] 45%              |
|                                                       |
|  현재 처리 중: file_name.mp4                          |
|  처리된 파일: 45/100                                  |
|  발견된 자막: 32                                      |
|                                                       |
+-------------------------------------------------------+
|  최근 로그 메시지:                                     |
|  - 12:45:30 INFO: 파일 'movie.mp4' 처리 완료          |
|  - 12:45:28 WARNING: 'show.srt'에 영어 자막 없음      |
+-------------------------------------------------------+
```

2. **검색 페이지**

```
+-------------------------------------------------------+
|                     헤더 / 네비게이션                   |
+-------------------------------------------------------+
|  자막 검색: [                          ] [ 검색 ]      |
|  필터: [ ] 영어만  [ ] 특정 시간대 [00:00 - 59:59]     |
+-------------------------------------------------------+
|  검색 결과: "hello world" (35건)                      |
|                                                       |
|  파일명        시작 시간    종료 시간    자막 내용      |
|  movie.mp4    00:15:23    00:15:26    Hello world!   |
|  series.mkv   00:03:45    00:03:48    Hello world... |
|  ...                                                  |
|                                                       |
+-------------------------------------------------------+
|  선택한 항목 미리보기:                                 |
|  "Hello world! How are you doing today?"             |
|                                                       |
|  [ 해당 미디어 열기 ] [ 자막 전체보기 ]                |
+-------------------------------------------------------+
```

3. **설정 페이지**

```
+-------------------------------------------------------+
|                     헤더 / 네비게이션                   |
+-------------------------------------------------------+
|                       설정                            |
+----------------------+--------------------------------+
| 설정 카테고리         |                                |
|                      |  루트 디렉토리:                 |
| > 디렉토리 설정       |  [/path/to/media] [찾아보기]   |
| > 데이터베이스 설정    |                                |
| > 인덱싱 설정         |  데이터베이스 위치:              |
| > 고급 설정           |  [/path/to/db.sqlite] [찾아보기]|
|                      |                                |
|                      |  [ 설정 저장 ]  [ 기본값 복원 ]  |
|                      |                                |
+----------------------+--------------------------------+
|             상태: 설정이 저장되었습니다.                |
+-------------------------------------------------------+
```

이 레이아웃 구조는 htmx와 Tailwind CSS를 사용하여 효율적으로 구현할 수 있으며, 반응형 디자인을 적용하여 다양한 화면 크기에 대응할 수 있습니다.

{% extends "base.html" %} {% block title %}대시보드 - 영어 자막 인덱서{%
endblock %} {% block content %}
<div class="container mx-auto px-4 py-8">
  <h1 class="text-2xl font-bold mb-6">인덱싱 통계 대시보드</h1>

  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
    <!-- 기본 통계 카드 -->
    <div class="bg-white p-6 rounded-lg shadow-md">
      <h2 class="text-lg font-semibold text-gray-700 mb-4">기본 통계</h2>
      <div id="stats-content" class="text-sm">
        <div class="animate-pulse">
          <div class="h-4 bg-gray-200 rounded w-3/4 mb-2"></div>
          <div class="h-4 bg-gray-200 rounded w-1/2 mb-2"></div>
          <div class="h-4 bg-gray-200 rounded w-2/3 mb-2"></div>
        </div>
        <p class="text-xs text-gray-500">데이터 로딩 중...</p>
      </div>
    </div>

    <!-- 자막 길이 분포 카드 -->
    <div class="bg-white p-6 rounded-lg shadow-md">
      <h2 class="text-lg font-semibold text-gray-700 mb-4">자막 길이 분포</h2>
      <div class="w-full h-64">
        <canvas id="lengthDistributionChart"></canvas>
      </div>
    </div>

    <!-- 일일 인덱싱 통계 카드 -->
    <div class="bg-white p-6 rounded-lg shadow-md">
      <h2 class="text-lg font-semibold text-gray-700 mb-4">일일 인덱싱 통계</h2>
      <div class="w-full h-64">
        <canvas id="dailyIndexingChart"></canvas>
      </div>
    </div>

    <!-- 미디어 확장자 통계 카드 -->
    <div class="bg-white p-6 rounded-lg shadow-md">
      <h2 class="text-lg font-semibold text-gray-700 mb-4">
        미디어 확장자 분포
      </h2>
      <div class="w-full h-64">
        <canvas id="extensionsChart"></canvas>
      </div>
    </div>

    <!-- 자막 있는/없는 미디어 비율 카드 -->
    <div class="bg-white p-6 rounded-lg shadow-md">
      <h2 class="text-lg font-semibold text-gray-700 mb-4">자막 유무 비율</h2>
      <div class="w-full h-64">
        <canvas id="subtitleRatioChart"></canvas>
      </div>
    </div>

    <!-- 인덱싱 컨트롤 카드 -->
    <div class="bg-white p-6 rounded-lg shadow-md">
      <h2 class="text-lg font-semibold text-gray-700 mb-4">인덱싱 컨트롤</h2>
      <div class="space-y-4">
        <div class="flex flex-wrap gap-2 mb-4">
          <button
            id="full-index-btn"
            class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded"
            hx-post="/api/index"
            hx-vals='{"incremental": false}'
            hx-swap="none"
          >
            전체 인덱싱
          </button>
          <button
            id="incremental-index-btn"
            class="bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded"
            hx-post="/api/index"
            hx-vals='{"incremental": true}'
            hx-swap="none"
          >
            증분 인덱싱
          </button>
          <button
            id="stop-index-btn"
            class="bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded"
            hx-post="/api/stop_indexing"
            hx-swap="none"
          >
            인덱싱 중지
          </button>
        </div>

        <h3 class="font-medium text-gray-700">인덱싱 상태</h3>
        <div
          id="indexing-status-container"
          hx-get="/api/indexing_status"
          hx-trigger="load, every 2s"
          hx-swap="innerHTML"
        >
          <div class="text-sm text-gray-500">상태 로딩 중...</div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // Chart.js 설정
  Chart.defaults.font.family =
    "Pretendard, -apple-system, BlinkMacSystemFont, system-ui, Roboto, sans-serif";
  Chart.defaults.color = "#555";

  document.addEventListener("DOMContentLoaded", function () {
    // 기본 통계 로드
    loadStats();

    // 차트 데이터 로드
    loadLengthDistribution();
    loadDailyStats();
    loadMediaStats();

    // htmx 이벤트 처리
    document.body.addEventListener("htmx:afterRequest", function (evt) {
      if (
        evt.detail.elt.id === "full-index-btn" ||
        evt.detail.elt.id === "incremental-index-btn"
      ) {
        // 인덱싱 시작 후 자동 상태 업데이트
        setTimeout(function () {
          htmx.trigger("#indexing-status-container", "load");
        }, 100);
      }

      // 인덱싱 완료 시 통계 갱신
      if (
        evt.detail.elt.getAttribute("hx-trigger") &&
        evt.detail.elt.getAttribute("hx-trigger").includes("stats-refresh")
      ) {
        loadStats();
        loadLengthDistribution();
        loadDailyStats();
        loadMediaStats();
      }
    });
  });

  // 기본 통계 로드
  function loadStats() {
    fetch("/api/stats")
      .then((response) => response.text())
      .then((html) => {
        document.getElementById("stats-content").innerHTML = html;
      });
  }

  // 자막 길이 분포 차트
  function loadLengthDistribution() {
    fetch("/api/stats/length-distribution")
      .then((response) => response.json())
      .then((data) => {
        const ctx = document.getElementById("lengthDistributionChart");
        new Chart(ctx, {
          type: "bar",
          data: {
            labels: data.labels,
            datasets: [
              {
                label: "자막 수",
                data: data.data,
                backgroundColor: [
                  "rgba(54, 162, 235, 0.6)",
                  "rgba(75, 192, 192, 0.6)",
                  "rgba(153, 102, 255, 0.6)",
                  "rgba(255, 159, 64, 0.6)",
                  "rgba(255, 99, 132, 0.6)",
                ],
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false,
              },
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  precision: 0,
                },
              },
            },
          },
        });
      });
  }

  // 일일 인덱싱 통계 차트
  function loadDailyStats() {
    fetch("/api/stats/daily")
      .then((response) => response.json())
      .then((data) => {
        const ctx = document.getElementById("dailyIndexingChart");
        new Chart(ctx, {
          type: "line",
          data: {
            labels: data.dates,
            datasets: [
              {
                label: "인덱스된 미디어",
                data: data.counts,
                fill: false,
                borderColor: "rgb(54, 162, 235)",
                tension: 0.1,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
          },
        });
      });
  }

  // 미디어 확장자 및 자막 비율 차트
  function loadMediaStats() {
    fetch("/api/media-stats")
      .then((response) => response.json())
      .then((data) => {
        // 확장자 차트
        const extensionsData = data.extensions;
        const labels = Object.keys(extensionsData);
        const counts = Object.values(extensionsData);

        const ctxExtensions = document.getElementById("extensionsChart");
        new Chart(ctxExtensions, {
          type: "pie",
          data: {
            labels: labels,
            datasets: [
              {
                data: counts,
                backgroundColor: [
                  "rgba(54, 162, 235, 0.7)",
                  "rgba(75, 192, 192, 0.7)",
                  "rgba(153, 102, 255, 0.7)",
                  "rgba(255, 159, 64, 0.7)",
                  "rgba(255, 99, 132, 0.7)",
                  "rgba(255, 205, 86, 0.7)",
                ],
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
          },
        });

        // 자막 비율 차트
        const subtitleRatio = data.subtitle_ratio;
        const ctxRatio = document.getElementById("subtitleRatioChart");
        new Chart(ctxRatio, {
          type: "doughnut",
          data: {
            labels: ["자막 있음", "자막 없음"],
            datasets: [
              {
                data: [subtitleRatio.has_subtitles, subtitleRatio.no_subtitles],
                backgroundColor: [
                  "rgba(75, 192, 192, 0.7)",
                  "rgba(255, 99, 132, 0.7)",
                ],
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
          },
        });
      });
  }
</script>
{% endblock %}

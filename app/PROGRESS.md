# 최근 데이터베이스 문제 해결 및 웹사이트 성능 개선 (2025-05-09)

## 문제점 및 해결 방법

### 1. 데이터베이스 연결 관리와 FTS 인덱스 구축 문제

#### 발견된 문제
- subtitles 테이블에는 "hello"가 포함된 자막이 132개 있었지만, subtitles_fts 테이블은 비어 있었음
- 데이터베이스 연결이 제대로 반환되지 않아 연결 풀 고갈 발생
- FTS 인덱스 재구축 시 오류 처리 부족
- Database 클래스와 새로운 모듈화된 구조 간의 호환성 문제

#### 해결 방법
1. **데이터베이스 연결 관리 개선**:
   - ConnectionPool 클래스에서 불필요한 로깅 제거
   - 컨텍스트 매니저를 사용하여 연결 자동 반환 구현

2. **FTS 인덱스 자동 복구 기능**:
   - 서버 시작 시 자동으로 FTS 인덱스 상태 확인 및 필요시 재구축
   - 예외 처리 개선 및 명확한 오류 메시지 제공

3. **Database 클래스와 모듈화된 구조의 호환성 유지**:
   - 함수 시그니처 일치: `search_subtitles()` 함수에 `search_method` 파라미터 지원

4. **서버 종료 시 리소스 정리**:
   - shutdown 이벤트에 데이터베이스 연결 풀 정리 로직 추가
   - 자막 감시 모듈 종료 로직 추가

## 향후 개선 방안

1. **통합 연결 관리**:
   - 여러 곳에 분산된 데이터베이스 접근 코드를 통합 모듈로 일원화
   - 직접 연결 생성 코드 제거 및 connection_context 사용 표준화

2. **서버 시작 속도 개선**:
   - FTS 인덱스 검증 작업을 백그라운드 스레드로 이동
   - 필요한 경우에만 FTS 인덱스 재구축 실행

3. **오류 복구 메커니즘 강화**:
   - 데이터베이스 손상 시 자동 복구 기능 구현
   - 백업 파일 관리 자동화

4. **성능 모니터링**:
   - 데이터베이스 연결 사용량 및 쿼리 성능 모니터링 추가
   - 연결 풀 상태 대시보드 구현

## 코드 개선 내용

1. **app/database/connection.py**:
   - 불필요한 로깅 제거하여 성능 개선
   - 연결 풀 관리 코드 최적화

2. **app/services/indexer.py**:
   - update_fts_index 함수에서 연결 컨텍스트 매니저 사용
   - 상세한 오류 로깅 추가

3. **app/main.py**:
   - 서버 시작/종료 이벤트 핸들러 개선
   - 데이터베이스 연결 풀 정리 로직 추가

4. **app/database/schema.py**:
   - rebuild_fts_index 함수의 예외 처리 개선
   - conn 변수 초기화 및 올바른 리소스 정리 보장

5. **app/database/__init__.py**:
   - Database 클래스의 search_subtitles 메서드에 search_method 파라미터 추가

# 자막 처리 기능 로깅 개선 (2025-05-10)

## 개선 내용

### 1. 자막 인코딩 변환 및 감시 모듈의 로깅 기능 강화

#### 문제점
- 자막 스캔 및 변환 과정에서 발생하는 상황을 터미널에서 실시간으로 확인하기 어려움
- 내부 처리 과정이 로그에 충분히 기록되지 않아 디버깅이 어려움

#### 해결 방법
1. **콘솔 로깅 추가**:
   - 자막 모듈의 로거에 콘솔 출력 핸들러 추가
   - 로그 레벨을 INFO로 설정하여 중요 정보가 모두 표시되도록 개선

2. **상세 로깅 정보 추가**:
   - 인코딩 변환 과정의 각 단계별 상세 로그 추가
   - 파일 처리 시작/완료, 인코딩 감지, 언어 감지, 처리 결과 등 상세 정보 기록

3. **자막 감시 모듈 로깅 개선**:
   - 파일 스캔, 처리 과정의 각 단계별 로그 추가
   - 처리 결과에 대한 상세 정보 제공

## 수정된 파일
1. **app/subtitle/encodings/converter.py**:
   - 콘솔 로깅 핸들러 추가
   - 변환 과정 상세 로깅 구현
   - 결과 상태 및 처리 단계 로깅 추가

2. **app/subtitle_watcher.py**:
   - 콘솔 로깅 핸들러 추가
   - 파일 감지 및 처리 과정 로깅 개선
   - 변환 결과 상태 기록 추가

## 효과
- 자막 변환 및 처리 과정을 실시간으로 터미널에서 확인 가능
- 문제 발생 시 디버깅이 용이해짐
- 로그를 통해 시스템의 동작 상태를 더 명확하게 파악 가능 